<!DOCTYPE html>
<html>
<head>
  <title>Viv Chat â€“ Chat</title>
  <script src="https://unpkg.com/parse/dist/parse.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #edf2f7;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      background-color: #2b6cb0;
      color: white;
      padding: 15px;
      text-align: center;
      font-size: 20px;
    }
    #chat-box {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    .message {
      background: white;
      border-radius: 8px;
      padding: 10px;
      margin: 5px 0;
      max-width: 80%;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .you {
      align-self: flex-end;
      background-color: #c6f6d5;
    }
    .other {
      align-self: flex-start;
      background-color: #fefcbf;
    }
    #input-area {
      display: flex;
      padding: 10px;
      background: white;
      border-top: 1px solid #ccc;
    }
    #receiver, #message {
      padding: 10px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    #receiver {
      width: 25%;
      margin-right: 5px;
    }
    #message {
      flex: 1;
      margin-right: 5px;
    }
    button {
      padding: 10px 15px;
      background-color: #3182ce;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background-color: #2b6cb0;
    }
  </style>
</head>
<body>
  <header>Viv Chat</header>
  <div id="chat-box"></div>
  <div id="input-area">
    <input type="text" id="receiver" placeholder="To (username)">
    <input type="text" id="message" placeholder="Type a message...">
    <button onclick="sendMessage()">Send</button>
  </div>

  <script>
    // Parse configuration
    Parse.initialize("NtcUKphlkMFY9kWIbXMFjzMI3O66bx6Ns9MgCL3m", "TmpoEPhIIdwJsKvp6WS96mBeGI4VK2jRmdcSlXPf");
    Parse.serverURL = "https://parseapi.back4app.com/";

    // Check if user is logged in
    const currentUser = Parse.User.current();
    if (!currentUser) {
      window.location.href = "index.html";
    }

    const currentUsername = currentUser.get("username");

    async function sendMessage() {
      const receiver = document.getElementById("receiver").value.trim();
      const text = document.getElementById("message").value.trim();
      if (!receiver || !text) return;

      const Message = Parse.Object.extend("viv_message");
      const msg = new Message();
      msg.set("sender", currentUsername);
      msg.set("receiver", receiver);
      msg.set("text", text);
      msg.set("timestamp", new Date());

      try {
        await msg.save();
        addMessage("you", text);
        document.getElementById("message").value = "";
      } catch (err) {
        alert("Error sending message: " + err.message);
      }
    }

    function addMessage(from, text) {
      const div = document.createElement("div");
      div.className = "message " + from;
      div.textContent = text;
      document.getElementById("chat-box").appendChild(div);
      div.scrollIntoView();
    }

    async function loadMessages() {
      const Message = Parse.Object.extend("viv_message");
      const query = new Parse.Query(Message);

      query.equalTo("receiver", currentUsername);
      query.descending("createdAt");
      query.limit(50);

      try {
        const results = await query.find();
        results.reverse().forEach(msg => {
          addMessage("other", `${msg.get("sender")}: ${msg.get("text")}`);
        });
      } catch (err) {
        console.error("Failed to load messages:", err);
      }
    }

    loadMessages();

    // Optional: auto-refresh every 10 seconds
    setInterval(loadMessages, 10000);
  </script>
</body>
</html>
