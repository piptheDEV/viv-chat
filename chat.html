<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viv Chat</title>
    <script src="https://unpkg.com/parse/dist/parse.min.js"></script>
    <style>
        /* Background canvas for particles */
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            font-family: 'Poppins', sans-serif;
            background: #0f0f0f;
            color: white;
        }
        canvas#bg {
            position: fixed;
            top: 0;
            left: 0;
            z-index: -1;
        }
        /* Chat container */
        .chat-container {
            max-width: 500px;
            height: 100vh;
            margin: auto;
            display: flex;
            flex-direction: column;
            background: rgba(20, 20, 20, 0.8);
            border-radius: 10px;
            overflow: hidden;
            backdrop-filter: blur(10px);
            box-shadow: 0px 0px 20px rgba(255, 255, 255, 0.1);
        }
        header {
            background: linear-gradient(90deg, #ff512f, #dd2476);
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.2em;
            font-weight: bold;
            color: white;
        }
        #globalChatBtn {
            background: white;
            color: black;
            padding: 5px 10px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }
        #globalChatBtn:hover {
            background: #ddd;
        }
        .chat-box {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        .my-message {
            background: linear-gradient(90deg, #ff512f, #dd2476);
            padding: 10px;
            border-radius: 10px;
            margin: 5px;
            align-self: flex-end;
            max-width: 80%;
        }
        .other-message {
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 10px;
            margin: 5px;
            align-self: flex-start;
            max-width: 80%;
        }
        .input-area {
            display: flex;
            padding: 10px;
            background: rgba(255,255,255,0.05);
        }
        #messageInput {
            flex: 1;
            padding: 10px;
            border: none;
            outline: none;
            border-radius: 5px;
            background: rgba(255,255,255,0.1);
            color: white;
        }
        #sendBtn {
            background: linear-gradient(90deg, #ff512f, #dd2476);
            border: none;
            padding: 10px 15px;
            margin-left: 10px;
            border-radius: 5px;
            cursor: pointer;
            color: white;
            font-weight: bold;
            transition: transform 0.2s;
        }
        #sendBtn:hover {
            transform: scale(1.05);
        }
    </style>
</head>
<body>
    <canvas id="bg"></canvas>

    <div class="chat-container">
        <header>
            <span>Viv Chat</span>
            <button id="globalChatBtn">üåç Global Chat</button>
        </header>

        <div class="chat-box" id="chatBox"></div>

        <div class="input-area">
            <input type="text" id="messageInput" placeholder="Type your message...">
            <button id="sendBtn">Send</button>
        </div>
    </div>

<script>
/* ==== INIT PARSE ==== */
Parse.initialize("NtcUKphlkMFY9kWIbXMFjzMI3O66bx6Ns9MgCL3m", "TmpoEPhIIdwJsKvp6WS96mBeGI4VK2jRmdcSlXPf");
Parse.serverURL = "https://parseapi.back4app.com/";
Parse.User.enableUnsafeCurrentUser();

/* ==== SESSION FIX ==== */
async function restoreSession() {
    const token = localStorage.getItem("sessionToken");
    if (!token) {
        window.location.href = "login.html";
        return;
    }

    try {
        await Parse.User.become(token);
        console.log("Session restored:", Parse.User.current().getUsername());
    } catch (err) {
        console.error("Session invalid:", err);
        localStorage.removeItem("sessionToken");
        window.location.href = "login.html";
    }
}
restoreSession();

/* ==== CHAT FUNCTIONS ==== */
const chatBox = document.getElementById("chatBox");
const messageInput = document.getElementById("messageInput");

async function loadMessages() {
    const Message = Parse.Object.extend("GlobalMessages");
    const query = new Parse.Query(Message);
    query.ascending("createdAt");
    const results = await query.find();

    chatBox.innerHTML = "";
    const currentUser = Parse.User.current()?.getUsername();

    results.forEach(msg => {
        const div = document.createElement("div");
        const sender = msg.get("sender");
        div.textContent = `${sender}: ${msg.get("text")}`;
        div.classList.add(sender === currentUser ? "my-message" : "other-message");
        chatBox.appendChild(div);
    });
    chatBox.scrollTop = chatBox.scrollHeight;
}

async function sendMessage() {
    const text = messageInput.value.trim();
    if (!text) return;

    const Message = Parse.Object.extend("GlobalMessages");
    const msg = new Message();
    msg.set("sender", Parse.User.current().getUsername());
    msg.set("text", text);
    await msg.save();

    messageInput.value = "";
    loadMessages();
}

document.getElementById("sendBtn").addEventListener("click", sendMessage);
messageInput.addEventListener("keypress", e => {
    if (e.key === "Enter") sendMessage();
});

setInterval(loadMessages, 3000);
loadMessages();

/* ==== PARTICLE BACKGROUND ==== */
const canvas = document.getElementById("bg");
const ctx = canvas.getContext("2d");
let particles = [];

function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
window.addEventListener("resize", resizeCanvas);
resizeCanvas();

function createParticles() {
    particles = [];
    for (let i = 0; i < 50; i++) {
        particles.push({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height,
            r: Math.random() * 3 + 1,
            dx: (Math.random() - 0.5) * 0.5,
            dy: (Math.random() - 0.5) * 0.5
        });
    }
}
createParticles();

function drawParticles() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "white";
    particles.forEach(p => {
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
        ctx.fill();

        p.x += p.dx;
        p.y += p.dy;

        if (p.x < 0 || p.x > canvas.width) p.dx *= -1;
        if (p.y < 0 || p.y > canvas.height) p.dy *= -1;
    });
    requestAnimationFrame(drawParticles);
}
drawParticles();
</script>
</body>
    </html>
