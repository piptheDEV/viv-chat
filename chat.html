<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Viv Chat</title>
    <script src="https://npmcdn.com/parse/dist/parse.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #121212;
            color: white;
            margin: 0;
            display: flex;
            height: 100vh;
        }
        .sidebar {
            width: 250px;
            background: #1e1e1e;
            padding: 10px;
            border-right: 1px solid #333;
        }
        .sidebar h2 {
            text-align: center;
        }
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .messages {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
        }
        .message {
            max-width: 60%;
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 10px;
            word-wrap: break-word;
        }
        .sent {
            background: #4caf50;
            align-self: flex-end;
        }
        .received {
            background: #333;
            align-self: flex-start;
        }
        .input-container {
            display: flex;
            padding: 10px;
            background: #1e1e1e;
        }
        input {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 5px;
        }
        button {
            margin-left: 10px;
            padding: 10px;
            border: none;
            border-radius: 5px;
            background: #4caf50;
            color: white;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2>Friends</h2>
        <input type="text" id="friendName" placeholder="Add friend">
        <button onclick="findFriend()">Add</button>
        <div id="friendList"></div>
    </div>
    <div class="chat-container">
        <div class="messages" id="messages"></div>
        <div class="input-container">
            <input type="text" id="messageInput" placeholder="Type your message...">
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>

    <script>
        // Initialize Parse
        Parse.initialize("YOUR_APP_ID", "YOUR_JS_KEY");
        Parse.serverURL = "https://parseapi.back4app.com/";

        let currentUser = Parse.User.current();
        let friendUser = null;

        if (!currentUser) {
            window.location.href = "login.html";
        }

        async function findFriend() {
            const friendName = document.getElementById("friendName").value.trim();
            if (!friendName) return alert("Enter a username");

            const query = new Parse.Query(Parse.User);
            query.equalTo("username", friendName);
            const result = await query.first();

            if (!result) {
                alert("User not found");
                return;
            }

            friendUser = result;
            document.getElementById("friendList").innerHTML = `<p>${friendUser.get("username")}</p>`;
            loadMessages();
        }

        async function sendMessage() {
            if (!friendUser) return alert("Select a friend first");
            const text = document.getElementById("messageInput").value.trim();
            if (!text) return;

            const Message = Parse.Object.extend("Messages");
            const msg = new Message();
            msg.set("sender", currentUser.get("username"));
            msg.set("receiver", friendUser.get("username"));
            msg.set("text", text);
            await msg.save();

            document.getElementById("messageInput").value = "";
            loadMessages();
        }

        async function loadMessages() {
            if (!friendUser) return;

            const query1 = new Parse.Query("Messages");
            query1.equalTo("sender", currentUser.get("username"));
            query1.equalTo("receiver", friendUser.get("username"));

            const query2 = new Parse.Query("Messages");
            query2.equalTo("sender", friendUser.get("username"));
            query2.equalTo("receiver", currentUser.get("username"));

            const mainQuery = Parse.Query.or(query1, query2);
            mainQuery.ascending("createdAt");

            const results = await mainQuery.find();

            const container = document.getElementById("messages");
            container.innerHTML = "";

            results.forEach(msg => {
                const div = document.createElement("div");
                div.classList.add("message");
                if (msg.get("sender") === currentUser.get("username")) {
                    div.classList.add("sent");
                } else {
                    div.classList.add("received");
                }
                div.innerText = msg.get("text");
                container.appendChild(div);
            });

            container.scrollTop = container.scrollHeight;
        }

        // Auto-refresh messages
        setInterval(loadMessages, 2000);
    </script>
</body>
</html>
