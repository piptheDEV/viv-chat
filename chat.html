<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viv-Chat</title>
    <script src="https://npmcdn.com/parse/dist/parse.min.js"></script>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #000;
            color: white;
        }
        #sidePanel {
            width: 200px;
            background: #111;
            color: white;
            padding: 10px;
            float: left;
            height: 100vh;
            overflow-y: auto;
            border-right: 1px solid #222;
        }
        #chatContainer {
            margin-left: 210px;
            padding: 10px;
        }
        .message {
            padding: 5px 10px;
            border-radius: 5px;
            margin: 5px 0;
            max-width: 60%;
            word-wrap: break-word;
        }
        .own-message {
            background: #0a84ff;
            margin-left: auto;
            text-align: right;
        }
        .other-message {
            background: #333;
            margin-right: auto;
            text-align: left;
        }
    </style>
</head>
<body>

<div id="sidePanel">
    <h3>Online Users</h3>
    <ul id="userList"></ul>
</div>

<div id="chatContainer">
    <div id="messages"></div>
    <input type="text" id="messageInput" placeholder="Type a message..." style="width:80%;">
    <button id="sendBtn">Send</button>
</div>

<script>
Parse.initialize("NtcUKphlkMFY9kWIbXMFjzMI3O66bx6Ns9MgCL3m", "TmpoEPhIIdwJsKvp6WS96mBeGI4VK2jRmdcSlXPf");
Parse.serverURL = "https://parseapi.back4app.com/";

const currentUser = Parse.User.current();
if (!currentUser) {
    window.location.href = "index.html";
}

// ===== OnlineUsers system =====
async function addToOnlineUsers() {
    const OnlineUsers = Parse.Object.extend("OnlineUsers");
    const query = new Parse.Query(OnlineUsers);
    query.equalTo("username", currentUser.get("username"));
    const result = await query.first();

    if (!result) {
        const newUser = new OnlineUsers();
        newUser.set("username", currentUser.get("username"));
        newUser.set("joinedAt", new Date());
        try {
            await newUser.save();
        } catch (err) {
            console.error("Error adding user:", err);
        }
    }
}

async function fetchOnlineUsers() {
    const OnlineUsers = Parse.Object.extend("OnlineUsers");
    const query = new Parse.Query(OnlineUsers);
    query.ascending("username");
    try {
        const results = await query.find();
        const list = document.getElementById("userList");
        list.innerHTML = "";
        results.forEach(user => {
            const li = document.createElement("li");
            li.textContent = user.get("username");
            list.appendChild(li);
        });
    } catch (err) {
        console.error("Error fetching online users:", err);
    }
}

addToOnlineUsers();
fetchOnlineUsers();
setInterval(fetchOnlineUsers, 5000);

// ===== Chat system (from your working code) =====
async function loadMessages() {
    const Message = Parse.Object.extend("Message");
    const query = new Parse.Query(Message);
    query.ascending("createdAt");
    try {
        const results = await query.find();
        const messagesDiv = document.getElementById("messages");
        messagesDiv.innerHTML = "";
        results.forEach(msg => {
            const msgEl = document.createElement("div");
            msgEl.classList.add("message");

            if (msg.get("username") === currentUser.get("username")) {
                msgEl.classList.add("own-message");
            } else {
                msgEl.classList.add("other-message");
            }

            msgEl.textContent = `${msg.get("username")}: ${msg.get("text")}`;
            messagesDiv.appendChild(msgEl);
        });
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    } catch (err) {
        console.error("Error loading messages:", err);
    }
}

async function sendMessage() {
    const text = document.getElementById("messageInput").value.trim();
    if (!text) return;
    const Message = Parse.Object.extend("Message");
    const message = new Message();
    message.set("username", currentUser.get("username"));
    message.set("text", text);
    try {
        await message.save();
        document.getElementById("messageInput").value = "";
        loadMessages();
    } catch (err) {
        console.error("Error sending message:", err);
    }
}

document.getElementById("sendBtn").addEventListener("click", sendMessage);
document.getElementById("messageInput").addEventListener("keypress", e => {
    if (e.key === "Enter") sendMessage();
});

loadMessages();
setInterval(loadMessages, 3000);
</script>

</body>
  </html>
