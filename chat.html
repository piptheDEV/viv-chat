<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Viv Chat â€“ Messages</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f7f7f7;
      margin: 0;
      padding: 0;
    }

    header {
      background: #6c63ff;
      color: white;
      padding: 20px;
      text-align: center;
      font-size: 24px;
    }

    #chat-container {
      display: flex;
      flex-direction: column;
      max-width: 600px;
      margin: 40px auto;
      background: white;
      border: 1px solid #ccc;
      border-radius: 8px;
      overflow: hidden;
    }

    #recipient-section {
      padding: 20px;
      background: #f0f0f0;
    }

    #recipient-section input {
      width: 100%;
      padding: 10px;
      font-size: 16px;
    }

    #messages {
      height: 300px;
      overflow-y: scroll;
      padding: 20px;
      background: #fff;
      border-top: 1px solid #eee;
      border-bottom: 1px solid #eee;
    }

    .message {
      margin-bottom: 10px;
    }

    .from-me {
      text-align: right;
      color: #6c63ff;
    }

    .from-other {
      text-align: left;
      color: #333;
    }

    #send-section {
      display: flex;
      padding: 10px;
      background: #fafafa;
    }

    #send-section input {
      flex: 1;
      padding: 10px;
      font-size: 16px;
    }

    #send-section button {
      padding: 10px 20px;
      background: #6c63ff;
      color: white;
      border: none;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <header>Viv Chat</header>
  <div id="chat-container">
    <div id="recipient-section">
      <input type="text" id="recipientInput" placeholder="Enter recipient username" />
    </div>

    <div id="messages"></div>

    <div id="send-section">
      <input type="text" id="messageInput" placeholder="Type a message..." />
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>

  <script src="https://unpkg.com/parse@3.4.4/dist/parse.min.js"></script>
  <script>
    Parse.initialize("NtcUKphlkMFY9kWIbXMFjzMI3O66bx6Ns9MgCL3m", "TmpoEPhIIdwJsKvp6WS96mBeGI4VK2jRmdcSlXPf");
    Parse.serverURL = "https://parseapi.back4app.com/";

    const currentUser = localStorage.getItem("viv_user");
    if (!currentUser) {
      alert("Not logged in. Redirecting...");
      window.location.href = "index.html";
    }

    const messagesDiv = document.getElementById("messages");
    const recipientInput = document.getElementById("recipientInput");
    const messageInput = document.getElementById("messageInput");

    // Track shown message IDs to prevent duplicates
    let shownMessageIds = new Set();

    async function sendMessage() {
      const recipient = recipientInput.value.trim();
      const message = messageInput.value.trim();
      if (!recipient || !message) return;

      const Message = Parse.Object.extend("Messages");
      const msg = new Message();
      msg.set("sender", currentUser);
      msg.set("receiver", recipient);
      msg.set("text", message);

      try {
        await msg.save();
        messageInput.value = "";
        fetchMessages();
      } catch (error) {
        alert("Error sending message: " + error.message);
      }
    }

    async function fetchMessages() {
      const recipient = recipientInput.value.trim();
      if (!recipient) return;

      const Message = Parse.Object.extend("Messages");
      const query1 = new Parse.Query(Message);
      query1.equalTo("sender", currentUser);
      query1.equalTo("receiver", recipient);

      const query2 = new Parse.Query(Message);
      query2.equalTo("sender", recipient);
      query2.equalTo("receiver", currentUser);

      const mainQuery = Parse.Query.or(query1, query2);
      mainQuery.ascending("createdAt");
      mainQuery.limit(100);

      try {
        const results = await mainQuery.find();

        for (const msg of results) {
          const msgId = msg.id;
          if (shownMessageIds.has(msgId)) continue;

          const msgEl = document.createElement("div");
          const from = msg.get("sender") === currentUser ? "from-me" : "from-other";
          msgEl.className = "message " + from;
          msgEl.textContent = `${msg.get("sender")}: ${msg.get("text")}`;
          messagesDiv.appendChild(msgEl);

          shownMessageIds.add(msgId);
        }

        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      } catch (error) {
        console.error("Fetch error:", error.message);
      }
    }

    recipientInput.addEventListener("change", () => {
      shownMessageIds.clear();
      messagesDiv.innerHTML = "";
      fetchMessages();
    });

    setInterval(fetchMessages, 5000); // refresh every 5 seconds
  </script>
</body>
</html>
