<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Fire Chat</title>
<script src="https://npmcdn.com/parse/dist/parse.min.js"></script>
<style>
    body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: black;
        overflow: hidden;
    }
    canvas#bg {
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        z-index: -1;
    }
    .container {
        display: flex;
        height: 100vh;
        color: white;
    }
    .friends-panel {
        width: 25%;
        background: rgba(20, 20, 20, 0.9);
        padding: 10px;
        overflow-y: auto;
    }
    .friends-panel h2 {
        color: orange;
        margin-top: 0;
    }
    .friend {
        padding: 8px;
        border-bottom: 1px solid rgba(255,255,255,0.2);
        cursor: pointer;
    }
    .chat-section {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: rgba(0,0,0,0.7);
    }
    .chat-header {
        padding: 10px;
        background: orange;
        font-weight: bold;
        display: flex;
        justify-content: space-between;
    }
    .messages {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
    }
    .message {
        margin: 5px 0;
        padding: 8px 12px;
        border-radius: 8px;
        max-width: 70%;
        clear: both;
    }
    .me {
        background: orange;
        float: right;
    }
    .other {
        background: #333;
        float: left;
    }
    .chat-input {
        display: flex;
    }
    .chat-input input {
        flex: 1;
        padding: 10px;
        border: none;
    }
    .chat-input button {
        padding: 10px;
        background: orange;
        border: none;
        cursor: pointer;
    }
    @media (max-width: 768px) {
        .friends-panel { width: 35%; }
    }
</style>
</head>
<body>

<canvas id="bg"></canvas>

<div class="container">
    <div class="friends-panel">
        <h2>Friends</h2>
        <div id="friendsList">Loading...</div>
        <button id="globalChatBtn" style="width:100%;margin-top:10px;background:orange;color:black;padding:8px;border:none;">Global Chat</button>
    </div>
    <div class="chat-section">
        <div class="chat-header" id="chatHeader">Global Chat</div>
        <div class="messages" id="messages"></div>
        <div class="chat-input">
            <input type="text" id="messageInput" placeholder="Type a message...">
            <button id="sendBtn">Send</button>
        </div>
    </div>
</div>

<script>
// Parse Init
Parse.initialize("NtcUKphlkMFY9kWIbXMFjzMI3O66bx6Ns9MgCL3m", "TmpoEPhIIdwJsKvp6WS96mBeGI4VK2jRmdcSlXPf");
Parse.serverURL = "https://parseapi.back4app.com/";

// Login check
const currentUser = JSON.parse(localStorage.getItem("currentUser"));
if (!currentUser) {
    window.location.href = "login.html";
}

// Add user to OnlineUsers if not already
(async function(){
    const OnlineUsers = Parse.Object.extend("OnlineUsers");
    const query = new Parse.Query(OnlineUsers);
    query.equalTo("username", currentUser.username);
    const res = await query.first();
    if (!res) {
        const userObj = new OnlineUsers();
        userObj.set("username", currentUser.username);
        await userObj.save();
    }
    loadFriends();
})();

let currentChat = "global";

async function loadFriends(){
    const OnlineUsers = Parse.Object.extend("OnlineUsers");
    const query = new Parse.Query(OnlineUsers);
    query.notEqualTo("username", currentUser.username);
    const res = await query.find();
    const friendsList = document.getElementById("friendsList");
    friendsList.innerHTML = "";
    if (res.length === 0) {
        friendsList.innerHTML = "No other users online.";
        return;
    }
    res.forEach(u=>{
        const div = document.createElement("div");
        div.className = "friend";
        div.textContent = u.get("username");
        div.onclick = ()=>{
            currentChat = u.get("username");
            document.getElementById("chatHeader").textContent = "Chat with " + currentChat;
            loadMessages();
        }
        friendsList.appendChild(div);
    });
}

document.getElementById("globalChatBtn").onclick = ()=>{
    currentChat = "global";
    document.getElementById("chatHeader").textContent = "Global Chat";
    loadMessages();
}

document.getElementById("sendBtn").onclick = sendMessage;

async function sendMessage(){
    const text = document.getElementById("messageInput").value.trim();
    if (!text) return;
    const Message = Parse.Object.extend("Messages");
    const msg = new Message();
    msg.set("sender", currentUser.username);
    msg.set("receiver", currentChat);
    msg.set("text", text);
    await msg.save();
    document.getElementById("messageInput").value = "";
    loadMessages();
}

async function loadMessages(){
    const Message = Parse.Object.extend("Messages");
    const query = new Parse.Query(Message);
    if (currentChat === "global") {
        query.equalTo("receiver", "global");
    } else {
        query.containedIn("receiver", [currentChat, currentUser.username]);
        query.containedIn("sender", [currentChat, currentUser.username]);
    }
    query.ascending("createdAt");
    const msgs = await query.find();
    const messagesDiv = document.getElementById("messages");
    messagesDiv.innerHTML = "";
    msgs.forEach(m=>{
        const div = document.createElement("div");
        div.className = "message " + (m.get("sender") === currentUser.username ? "me" : "other");
        div.textContent = m.get("text");
        messagesDiv.appendChild(div);
    });
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

setInterval(loadMessages, 2000);
loadMessages();

// Background animation
const canvas = document.getElementById("bg");
const ctx = canvas.getContext("2d");
let particles = [];
function resize(){canvas.width = innerWidth;canvas.height = innerHeight;}
resize();
window.addEventListener("resize", resize);

class Particle {
    constructor(){
        this.x = Math.random()*canvas.width;
        this.y = Math.random()*canvas.height;
        this.r = Math.random()*3+1;
        this.dx = (Math.random()-0.5)*0.5;
        this.dy = (Math.random()-0.5)*0.5;
    }
    draw(){
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.r, 0, Math.PI*2);
        ctx.fillStyle = "orange";
        ctx.fill();
    }
    update(){
        this.x += this.dx;
        this.y += this.dy;
        if(this.x<0||this.x>canvas.width) this.dx*=-1;
        if(this.y<0||this.y>canvas.height) this.dy*=-1;
        this.draw();
    }
}
for(let i=0;i<100;i++) particles.push(new Particle());

function animate(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    particles.forEach(p=>p.update());
    requestAnimationFrame(animate);
}
animate();
</script>
</body>
                                                                                                                                            </html>
